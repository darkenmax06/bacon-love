---
/**
 * Custom DatePicker Component
 * Calendar-style date picker with dynamic booking window and closed dates
 */
export interface Props {
  id?: string;
  name?: string;
  required?: boolean;
  placeholder?: string;
  defaultDate?: string; // YYYY-MM-DD format
  lang?: 'es' | 'en';
}

const {
  id = 'datepicker',
  name = 'date',
  required = false,
  placeholder,
  defaultDate,
  lang = 'es'
} = Astro.props;

const monthNames = lang === 'es'
  ? ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
  : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

const dayNames = lang === 'es'
  ? ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb']
  : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
---

<div class="datepicker-wrapper" data-id={id}>
  <input
    type="hidden"
    id={id}
    name={name}
    required={required}
    value={defaultDate || ''}
  />

  <button type="button" class="datepicker-trigger">
    <span class="selected-date">{placeholder || (lang === 'es' ? 'Seleccionar fecha' : 'Select date')}</span>
    <svg class="calendar-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor">
      <rect x="3" y="4" width="14" height="14" rx="2" stroke-width="2"/>
      <path d="M3 8h14M7 2v4M13 2v4" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <div class="datepicker-dropdown" style="display: none;">
    <div class="datepicker-header">
      <button type="button" class="nav-btn prev-month" aria-label="Mes anterior">
        ‹
      </button>
      <div class="current-month"></div>
      <button type="button" class="nav-btn next-month" aria-label="Mes siguiente">
        ›
      </button>
    </div>

    <div class="datepicker-calendar">
      <div class="calendar-weekdays">
        {dayNames.map(day => <div class="weekday">{day}</div>)}
      </div>
      <div class="calendar-days"></div>
    </div>
  </div>
</div>

<script define:vars={{ id, lang, monthNames, defaultDate }}>
(function() {
  const wrapper = document.querySelector(`.datepicker-wrapper[data-id="${id}"]`);
  if (!wrapper) return;

  const hiddenInput = wrapper.querySelector('input[type="hidden"]');
  const trigger = wrapper.querySelector('.datepicker-trigger');
  const dropdown = wrapper.querySelector('.datepicker-dropdown');
  const selectedDateSpan = wrapper.querySelector('.selected-date');
  const currentMonthEl = wrapper.querySelector('.current-month');
  const prevBtn = wrapper.querySelector('.prev-month');
  const nextBtn = wrapper.querySelector('.next-month');
  const calendarDays = wrapper.querySelector('.calendar-days');

  let settings = null;
  let closedDates = [];
  let currentDate = new Date();
  let selectedDate = defaultDate ? new Date(defaultDate + 'T00:00:00.000Z') : null;
  let minDate = new Date();
  minDate.setHours(0, 0, 0, 0);
  let maxDate = null;
  let dataLoaded = false;

  // Load settings and closed dates
  async function loadData() {
    try {
      const [settingsRes, closedDatesRes] = await Promise.all([
        fetch('/api/settings'),
        fetch('/api/closed-dates')
      ]);

      const settingsData = await settingsRes.json();
      const closedDatesData = await closedDatesRes.json();

      settings = settingsData.settings;
      closedDates = closedDatesData.closedDates.map(cd => {
        const date = new Date(cd.date);
        return {
          ...cd,
          dateStr: `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')}`
        };
      });

      // Calculate maxDate based on advanceBookingDays
      maxDate = new Date();
      maxDate.setDate(maxDate.getDate() + settings.advanceBookingDays);
      maxDate.setHours(23, 59, 59, 999);

      dataLoaded = true;
      renderCalendar();
    } catch (error) {
      console.error('Error loading datepicker data:', error);
      dataLoaded = true; // Allow opening even on error
    }
  }

  // Check if a day is enabled in schedules
  function isDayEnabled(date) {
    if (!settings) return true;

    const dayOfWeek = date.getDay().toString();

    if (settings.daySchedules) {
      const daySchedule = settings.daySchedules[dayOfWeek];
      return daySchedule && daySchedule.enabled && daySchedule.times.length > 0;
    } else {
      // Legacy system
      return settings.openDays.includes(dayOfWeek);
    }
  }

  // Check if date is closed
  function isClosedDate(dateStr) {
    return closedDates.some(cd => cd.dateStr === dateStr);
  }

  // Check if date is selectable
  function isSelectableDate(date) {
    if (!settings) return false;

    const dateObj = new Date(date);
    dateObj.setHours(0, 0, 0, 0);

    // Check if date is in valid range
    if (dateObj < minDate || dateObj > maxDate) return false;

    // Format date string for comparison
    const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

    // Check if date is closed
    if (isClosedDate(dateStr)) return false;

    // Check if day of week is enabled
    if (!isDayEnabled(dateObj)) return false;

    return true;
  }

  // Format date for display
  function formatDate(date) {
    const d = new Date(date);
    const day = String(d.getUTCDate()).padStart(2, '0');
    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
    const year = d.getUTCFullYear();
    return `${day}/${month}/${year}`;
  }

  // Render calendar
  function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update header
    currentMonthEl.textContent = `${monthNames[month]} ${year}`;

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Clear calendar
    calendarDays.innerHTML = '';

    // Add empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day empty';
      calendarDays.appendChild(emptyCell);
    }

    // Add days of month
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

      const dayCell = document.createElement('button');
      dayCell.type = 'button';
      dayCell.className = 'calendar-day';
      dayCell.textContent = day;
      dayCell.dataset.date = dateStr;

      // Check if this is today
      const today = new Date();
      if (date.getFullYear() === today.getFullYear() &&
          date.getMonth() === today.getMonth() &&
          date.getDate() === today.getDate()) {
        dayCell.classList.add('today');
      }

      // Check if this is selected date
      if (selectedDate && date.getFullYear() === selectedDate.getUTCFullYear() &&
          date.getMonth() === selectedDate.getUTCMonth() &&
          date.getDate() === selectedDate.getUTCDate()) {
        dayCell.classList.add('selected');
      }

      // Check if date is selectable
      if (isSelectableDate(date)) {
        dayCell.addEventListener('click', () => selectDate(dateStr));
      } else {
        dayCell.classList.add('disabled');
        dayCell.disabled = true;

        // Add closed indicator
        if (isClosedDate(dateStr)) {
          dayCell.classList.add('closed');
          const closedInfo = closedDates.find(cd => cd.dateStr === dateStr);
          dayCell.title = closedInfo ? closedInfo.reason : 'Cerrado';
        }
      }

      calendarDays.appendChild(dayCell);
    }

    // Update navigation buttons
    updateNavButtons();
  }

  // Update navigation button states
  function updateNavButtons() {
    if (!settings) return;

    const currentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const maxMonth = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
    const minMonth = new Date(minDate.getFullYear(), minDate.getMonth(), 1);

    // Disable prev button if at or before current month
    prevBtn.disabled = currentMonth <= minMonth;

    // Disable next button if at or after max booking month
    nextBtn.disabled = currentMonth >= maxMonth;
  }

  // Select date
  function selectDate(dateStr) {
    selectedDate = new Date(dateStr + 'T00:00:00.000Z');
    hiddenInput.value = dateStr;
    selectedDateSpan.textContent = formatDate(selectedDate);

    // Dispatch custom event with date detail
    const customEvent = new CustomEvent('date-selected', {
      bubbles: true,
      detail: { date: dateStr }
    });
    document.dispatchEvent(customEvent);

    // Also dispatch change event for backward compatibility
    hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));

    // Close dropdown
    dropdown.style.display = 'none';

    // Re-render to update selected state
    renderCalendar();
  }

  // Toggle dropdown
  trigger.addEventListener('click', () => {
    if (!dataLoaded) {
      // Still loading data, show in button or wait
      return;
    }
    const isVisible = dropdown.style.display !== 'none';
    dropdown.style.display = isVisible ? 'none' : 'block';

    // Render calendar when opening if not visible before
    if (!isVisible) {
      renderCalendar();
    }
  });

  // Navigation
  prevBtn.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  });

  nextBtn.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!wrapper.contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });

  // Initialize
  loadData();

  // Update selected date display if defaultDate provided
  if (defaultDate && selectedDate) {
    selectedDateSpan.textContent = formatDate(selectedDate);
  }
})();
</script>

<style>
.datepicker-wrapper {
  position: relative;
  width: 100%;
}

.datepicker-trigger {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 12px;
  background-color: rgba(25, 24, 24, 0.6);
  border: 1px solid rgba(243, 238, 238, 0.2);
  border-radius: 8px;
  color: var(--white);
  font-family: "jost", sans-serif;
  font-size: 1rem;
  cursor: pointer;
  transition: border-color 0.3s;
}

.datepicker-trigger:hover {
  border-color: rgba(243, 238, 238, 0.4);
}

.datepicker-trigger:focus {
  outline: none;
  border-color: var(--white);
}

.selected-date {
  flex: 1;
  text-align: left;
}

.calendar-icon {
  margin-left: 8px;
  opacity: 0.7;
}

.datepicker-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  margin-top: 8px;
  background: linear-gradient(135deg, rgba(8, 8, 8, 0.98) 0%, rgba(5, 5, 5, 1) 100%);
  border: 1px solid rgba(243, 238, 238, 0.2);
  border-radius: 12px;
  padding: 16px;
  z-index: 1000;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
}

.datepicker-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.current-month {
  font-family: "stella", serif;
  font-size: 1.25rem;
  color: var(--white);
  font-weight: 600;
}

.nav-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(243, 238, 238, 0.1);
  border: 1px solid rgba(243, 238, 238, 0.2);
  border-radius: 6px;
  color: var(--white);
  font-size: 1.5rem;
  cursor: pointer;
  transition: all 0.2s;
}

.nav-btn:hover:not(:disabled) {
  background: rgba(243, 238, 238, 0.2);
  border-color: rgba(243, 238, 238, 0.4);
}

.nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-bottom: 8px;
}

.weekday {
  text-align: center;
  font-family: "jost", sans-serif;
  font-size: 0.75rem;
  font-weight: 700;
  color: rgba(243, 238, 238, 0.6);
  text-transform: uppercase;
  padding: 8px 0;
}

.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "jost", sans-serif;
  font-size: 0.9rem;
  color: var(--white);
  background: transparent;
  border: 1px solid transparent;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.calendar-day:not(.disabled):not(.empty):hover {
  background: rgba(243, 238, 238, 0.1);
  border-color: rgba(243, 238, 238, 0.3);
}

.calendar-day.today {
  border-color: rgba(243, 238, 238, 0.4);
}

.calendar-day.selected {
  background: var(--white);
  color: var(--black);
  font-weight: 700;
}

.calendar-day.disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.calendar-day.closed {
  color: #ff6b6b;
  text-decoration: line-through;
}

.calendar-day.closed::after {
  content: '✕';
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.6rem;
  color: #ff6b6b;
}

.calendar-day.empty {
  pointer-events: none;
}

@media (max-width: 768px) {
  .datepicker-dropdown {
    position: fixed;
    top: 50%;
    left: 50%;
    right: auto;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 400px;
  }
}
</style>
